<% nav_links = {
    "Home" => user_logged_in? ? home_path : login_path,
    "My Projects" => user_logged_in? ? projects_path : login_path,
    "Explore" => explore_path,
    "Tool Bag" => toolbag_path,
    "Starter Projects" => starter_projects_path,
    "Guides" => guides_path,
    "FAQ" => faq_path,
    "Admin" => current_user&.admin? ? admin_root_path : nil
} %>

<% normalize_path = ->(p) { p.to_s.sub(%r{/$}, "") } %>
<% req = normalize_path.call(request.path) %>
<% current_nav = nav_links.find { |_, path|
     p = normalize_path.call(path)
     p.present? && (req == p || req.start_with?("#{p}/"))
   }&.first %>

<nav id="global-nav" data-controller="nav" data-turbo-permanent class="fixed left-0 top-0 bottom-0 overflow-hidden w-[15rem] bg-bp-darker flex flex-col py-8 px-6 print:hidden space-y-8 shadow-xl shadow-black/50">
    <a class="text-center" href="<%= user_logged_in? ? home_path : root_path %>">
        <p class="text-4xl font-rcgl-full">Blueprint</p>
    </a>
    <div class="flex flex-col space-y-3 grow">
        <% nav_links.each do |name, path| %>
            <% next if path.nil? %>
            <% match = ["Starter Projects", "Guides"].include?(name) ? "prefix" : "exact" %>
            <%= render "shared/button", url: path, text: name, variant: current_nav == name ? :nav_active : :nav, class: "text-base py-1.5 #{name == "Admin" ? "text-orange-400 border-orange-400" : ""}", html_options: { data: { nav_target: "link", nav_match: match } } %>

            <% if name == "Guides" %>
                <ul data-nav-target="submenu" data-submenu-base="/guides" class="text-sm flex-col space-y-1 list-disc list-inside hidden">
                    <% guides_menu_items.each do |item| %>
                      <li>
                        <a href="<%= item[:path] %>" data-nav-target="sublink" data-nav-match="prefix" title="<%= item[:description] %>"><%= item[:title] %></a>
                      </li>
                    <% end %>
                </ul>
            <% end %>
            
        <% end %>
    </div>
    <% if user_logged_in? %>
        <div class="flex flex-col space-y-1">
            <%= link_to user_path(current_user), class: "flex items-center space-x-4" do %>
                <div class="flex items-center space-x-4">
                    <% avatar_url = current_user.avatar || "https://hc-cdn.hel1.your-objectstorage.com/s/v3/c283ae01214b9052480f1e216e43dbe09a424048_image.png" %>
                    <% name = current_user.display_name || current_user.email || "unknown" %>
                    <img src="<%= avatar_url %>" alt="<%= name %>'s avatar" class="rounded-lg size-12">
                    <div>
                        <p class="w-32 truncate whitespace-nowrap"><%= name %></p>
                        <p>0 Tickets</p>
                    </div>
                </div>
            <% end %>
            <%= button_to logout_path , method: :delete, class: "flex items-center space-x-2" do %>
                <span>Log out</span>
                <%= inline_svg "icons/logout.svg", class: "size-2" %>
            <% end %>
        </div>
    <% else %>
        <%= render "shared/button", url: login_path(redirect_to: request.fullpath), text: "Log in" %>
    <% end %>
</nav>
